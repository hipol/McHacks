<!DOCTYPE html>
<html xmlns = "http://www.w3.org/1999/xhtml">
<head>

<script src = "correlation_worker.js"></script>
<script type="text/javascript">

// Define the set of test frequencies that we'll use to analyze microphone data.
var C4 = 261.626; // C2 note, in Hz.
var notes = ["c4", "c#4", "d4", "d#4", "e4", "f4", "f#4", "g4", "g#4", "a4", "a#4", "b4"];
var test_frequencies = [];
var summation = 0;
var counter = 0;
var averageMert = 0;
var tempArray = [];
var unfilteredArray = [];
var filteredArray = [];
var filled = false;
var recording = false;

function filterArray(unfilteredArray)	{
	var filteredArray = [];
	for(var i = 0; i < unfilteredArray.length; i++)	{
		var duration = 0;
		while(unfilteredArray[i] == unfilteredArray[i+1])	{
			duration += 50;
			i++;
		}
		filteredArray.push([100, 0, unfilteredArray[i], 127, duration]);
	}
}

for (var i = 0; i < 30; i++)
{
	var note_frequency = C4 * Math.pow(2, i / 12);
	var note_name = notes[i%12];
	var note = { "frequency": note_frequency, "name": note_name };
	var just_above = { "frequency": note_frequency * Math.pow(2, 1 / 48), "name": note_name + " (a bit sharp)" };
	var just_below = { "frequency": note_frequency * Math.pow(2, -1 / 48), "name": note_name + " (a bit flat)" };
	test_frequencies = test_frequencies.concat([note]);
}
window.addEventListener("load", initialize);
var correlation_worker = new Worker(URL.createObjectURL(new Blob(["("+worker_function.toString()+")()"], {type: 'text/javascript'})));
correlation_worker.addEventListener("message", interpret_correlation_result);


function toggle(button)
{
  if(document.getElementById("recorder").value=="record"){
   document.getElementById("recorder").value="stop recording";
   recording = true;
}

  else if(document.getElementById("recorder").value=="stop recording"){
   document.getElementById("recorder").value="record";
   recording = false;
}
}

function initialize()
{
	var get_user_media = navigator.getUserMedia;
	get_user_media = get_user_media || navigator.webkitGetUserMedia;
	get_user_media = get_user_media || navigator.mozGetUserMedia;
	get_user_media.call(navigator, { "audio": true }, use_stream, function() {});
	//document.getElementById("play-note").addEventListener("click", toggle_playing_note);
}
function use_stream(stream)
{
	var audio_context = new AudioContext();
	var microphone = audio_context.createMediaStreamSource(stream);
	var script_processor = audio_context.createScriptProcessor(1024, 1, 1);
	script_processor.connect(audio_context.destination);
	microphone.connect(script_processor);
	var buffer = [];
	var sample_length_milliseconds = 250;
	var recording = true;
	// Need to leak this function into the global namespace so it doesn't get
	// prematurely garbage-collected.
	// http://lists.w3.org/Archives/Public/public-audio/2013JanMar/0304.html
	window.capture_audio = function(event)
	{


		if (!recording)
			return;
		buffer = buffer.concat(Array.prototype.slice.call(event.inputBuffer.getChannelData(0)));
		// Stop recording after sample_length_milliseconds.
		if (buffer.length > sample_length_milliseconds * audio_context.sampleRate / 1000)
		{
			recording = false;
			correlation_worker.postMessage
			(
				{
					"timeseries": buffer,
					"test_frequencies": test_frequencies,
					"sample_rate": audio_context.sampleRate
				}
			);
			buffer = [];
			setTimeout(function() { recording = true; }, 1);
		}
	};
	script_processor.onaudioprocess = window.capture_audio;
}
function interpret_correlation_result(event)
{
	var timeseries = event.data.timeseries;
	var frequency_amplitudes = event.data.frequency_amplitudes;
	// Compute the (squared) magnitudes of the complex amplitudes for each
	// test frequency.
	var magnitudes = frequency_amplitudes.map(function(z) { return z[0] * z[0] + z[1] * z[1]; });
	// Find the maximum in the list of magnitudes.
	var maximum_index = -1;
	var maximum_magnitude = 0;
	for (var i = 0; i < magnitudes.length; i++)
	{
		if (magnitudes[i] <= maximum_magnitude)
			continue;
		maximum_index = i;
		maximum_magnitude = magnitudes[i];
	}
	// Compute the average magnitude. We'll only pay attention to frequencies
	// with magnitudes significantly above average.
	var average = magnitudes.reduce(function(a, b) { return a + b; }, 0) / magnitudes.length;
	var confidence = maximum_magnitude / average;
	var confidence_threshold = 10; // empirical, arbitrary.
	var dominant_frequency = test_frequencies[maximum_index];
	if (confidence > confidence_threshold)
	{
		summation += dominant_frequency.frequency;
		counter ++;
		//console.log(dominant_frequency.frequency);
		//document.getElementById("note-name").textContent = dominant_frequency.name;
		//document.getElementById("frequency").textContent = dominant_frequency.frequency;


	}
	else {
		counter++;
		summation += dominant_frequency.frequency;
		//console.log(dominant_frequency.frequency)
	}

	if(counter==10)	{
			summation /= 10;
			counter = 0;
			averageMert = summation;
			//console.log(average + "    " + counter);
		}

	document.getElementById("average").textContent = averageMert;
	//console.log(averageMert);
	var noteArray = ["C4", "C#4", "D4", "D#4", "E4", "F4", "F#4", "G4", "G#4", "A4", "A#4", "B4"];
	var frequencyArray = [];
	for (var i = 0; i < 30; i++)
	{
		var freq = C4 * Math.pow(2, i / 12);
		var noteName = noteArray[i%12];
		var noteMert = noteName;
		frequencyArray = frequencyArray.concat([freq]);
	}
	//console.log(frequencyArray);
	//console.log(noteArray);

	var noteDisplay;
	for(var i = 0; i<30; i++)	{
		if(averageMert <= frequencyArray[0])	{
			noteDisplay = noteArray[0];
			break;
		}
		if(averageMert >= frequencyArray[29])	{
			noteDisplay = noteArray[29%12];
			break;
		}
		if(averageMert < frequencyArray[i+1])	{
			distance = (frequencyArray[i] + frequencyArray[i+1])/2;
			if(averageMert >= distance)
				noteDisplay = noteArray[(i+1)%12];
			else
				noteDisplay = noteArray[i%12];
			break;
		}

	}

	if(recording)	{
		tempArray.push(noteDisplay);
		console.log("ahh");
		filled = false;
	}
	else {
		if(!filled)	{
			unfilteredArray = tempArray;
			filteredArray = filterArray(unfilteredArray);
			console.log(filteredArray);
			console.log("hello");
		}
		filled = true;
		tempArray = [];

	}
	//console.log(finalArray);
	document.getElementById("noteDisplay").textContent = noteDisplay;
}

</script>







	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<!-- shim -->
	<script src="/inc/shim/Base64.js" type="text/javascript"></script>
	<script src="/inc/shim/Base64binary.js" type="text/javascript"></script>
	<script src="/inc/shim/WebAudioAPI.js" type="text/javascript"></script>
	<script src="/inc/shim/WebMIDIAPI.js" type="text/javascript"></script>
	<!-- jasmid package -->
	<script src="/inc/jasmid/stream.js"></script>
	<script src="/inc/jasmid/midifile.js"></script>
	<script src="/inc/jasmid/replayer.js"></script>
	<!-- midi.js package -->
	<script src="/js/midi/audioDetect.js" type="text/javascript"></script>
	<script src="/js/midi/gm.js" type="text/javascript"></script>
	<script src="/js/midi/loader.js" type="text/javascript"></script>
	<script src="/js/midi/plugin.audiotag.js" type="text/javascript"></script>
	<script src="/js/midi/plugin.webaudio.js" type="text/javascript"></script>
	<script src="/js/midi/plugin.webmidi.js" type="text/javascript"></script>
	<script src="/js/midi/player.js" type="text/javascript"></script>
	<script src="/js/midi/synesthesia.js" type="text/javascript"></script>
	<!-- utils -->
	<script src="/js/util/dom_request_xhr.js" type="text/javascript"></script>
	<script src="/js/util/dom_request_script.js" type="text/javascript"></script>
	<!-- includes -->
	<script src="examples/inc/timer.js" type="text/javascript"></script>
	<script src="examples/inc/colorspace.js" type="text/javascript"></script>
	<script src="examples/inc/event.js" type="text/javascript"></script>

<!-- midi writer -->
	<script src="js/JZZ.Midi.js"></script>
	<script src="js/JZZ.MidiFile.js"></script>


</head>

<body>
<p>It sounds like you're playing...</p>
<h1 id="noteDisplay"></h1>
<p>
	<span>frequency:</span>
	<span id="average"></span>
</p>
<hr>
<button id="play-note">start/stop an E note</button>
<form action="">
<input type="button" id="recorder" value="record" style="color:blue"
       onclick="toggle(this);">
</form>
</body>

<script><!--

// passes an array of notes:
//Note: 1 --> clock: 100, MIDI channel: 0, note: F5, velocity: 127, duration: 100 clocks
//Note: 2 --> clock: 200, MIDI channel: 0, note: E5, velocity: 127, duration: 50 clocks
//End time = 300 clocks
createMIDI([[100,0,'F5',127,100], [200,0,'E5',127,50]],300);


function createMIDI(notesArray, end) {

	// Create a MIDI file. Type 1; 100 clocks per quarter note.
	// Normally, it would rather be 96, but 100 makes it easier to count.
	mf = new JZZ_.MidiFile(1,100);

	var tr0 = new JZZ_.MidiFile.MTrk; mf.push(tr0);
	tr0.addTempo(0,120); // Set to 120 BPM

	// Add MIDI file tracks:
	var tr2 = new JZZ_.MidiFile.MTrk; mf.push(tr2); // This one will be for the music

	tr2.addName(0,'Music');
	tr2.addMidi(0,0xc0,0x0b); // clock: 0, MIDI signal: 0xc0 0x0b (change channel 0 program to vibraphone)

	//tr2.addNote(100,0,'F5',127,50); // clock: 100, MIDI channel: 0, note: E5, velocity: 127, duration: 50 clocks
	var notesArrayLength = notesArray.length;
	for (var i = 0; i < notesArrayLength; i++) {
		console.log(notesArray[i]);
    tr2.addNote(notesArray[i][0], notesArray[i][1], notesArray[i][2], notesArray[i][3], notesArray[i][4]);
    //Do something
	}

	tr2.setTime(end); // otherwise it will end on clock 1690

	var str = mf.dump(); // MIDI file dumped as a string
	var b64 = JZZ_.MidiFile.toBase64(str); // convert to base-64 string
	var uri = 'data:audio/midi;base64,' + b64; // data URI


	MIDI.loadPlugin({
	soundfontUrl: "examples/soundfont/",
	instrument: "acoustic_grand_piano",
	onprogress: function(state, progress) {
		console.log(state, progress);
	},
	onsuccess: function() {


		MIDI.Player.loadFile(uri, MIDI.Player.start); // load .MIDI from base64 or binary XML
	}

});

}







</script>


</html>


